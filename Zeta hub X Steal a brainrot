--!strict
-- Improved Anti-Kick & Crash Bypass with proper game shutdown handling
pcall(function()
    local Players = game:GetService("Players")
    local LocalPlayer = Players.LocalPlayer
    local mt = getrawmetatable(game)
    local gameShuttingDown = false

    -- Listen for game shutdown
    game:BindToClose(function()
        gameShuttingDown = true
    end)

    if setreadonly then setreadonly(mt, false) end

    local oldNamecall = mt.__namecall
    local oldIndex = mt.__index

    mt.__namecall = newcclosure(function(self, ...)
        if gameShuttingDown then return oldNamecall(self, ...) end
        
        local method = getnamecallmethod()
        if typeof(method) == "string" and method:lower() == "kick" then
            warn("Kick attempt blocked via __namecall")
            return nil
        end
        return oldNamecall(self, ...)
    end)

    mt.__index = newcclosure(function(self, key)
        if gameShuttingDown then return oldIndex(self, key) end
        
        if typeof(key) == "string" then
            local lowered = key:lower()
            if lowered == "kick" then
                warn("Kick attempt blocked via __index")
                return function() end
            elseif (lowered == "breakjoints" or lowered == "destroy") and not gameShuttingDown then
                warn("Destructive method '"..key.."' blocked via __index")
                return function() end
            end
        end
        return oldIndex(self, key)
    end)

    if LocalPlayer then
        local originalKick = LocalPlayer.Kick
        LocalPlayer.Kick = function(self, ...)
            if not gameShuttingDown then
                warn("Kick attempt blocked via .Kick override")
                return nil
            end
            return originalKick(self, ...)
        end
    end

    local function protectCharacter(char)
        for _, part in ipairs(char:GetDescendants()) do
            if part:IsA("BasePart") then
                local originalDestroy = part.Destroy
                part.Destroy = function(self, ...)
                    if not gameShuttingDown then
                        warn("Attempted to destroy character part: " .. part.Name)
                        return nil
                    end
                    return originalDestroy(self, ...)
                end
            end
        end
        local hum = char:FindFirstChildWhichIsA("Humanoid")
        if hum then
            hum.BreakJointsOnDeath = false
        end
    end

    if LocalPlayer.Character then
        protectCharacter(LocalPlayer.Character)
    end
    LocalPlayer.CharacterAdded:Connect(protectCharacter)

    if setreadonly then setreadonly(mt, true) end
end)

-- Load RedzLib
local success, redzlib = pcall(function()
    return loadstring(game:HttpGet("https://raw.githubusercontent.com/tbao143/Library-ui/refs/heads/main/Redzhubui"))()
end)

if not success then
    warn("Failed to load RedzLib:", redzlib)
    return
end

-- Create Interface
local Window = redzlib:MakeWindow({
    Title = "Zeta Hub X Steal a brainrot",
    SubTitle = "by S I L E N T",
    SaveFolder = "ZetaHubUniversal"
})

Window:AddMinimizeButton({
    Button = { Image = "rbxassetid://100006760882280", BackgroundTransparency = 0 },
    Corner = { CornerRadius = UDim.new(0, 6) },
})

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local Workspace = game:GetService("Workspace")

-- Player & Character References
local LocalPlayer = Players.LocalPlayer
local character, humanoid
local markedLocation = nil
local baseBlockLocation = nil

local function updateReferences()
    character = LocalPlayer.Character
    humanoid = character and character:FindFirstChildOfClass("Humanoid") or nil
end

LocalPlayer.CharacterAdded:Connect(updateReferences)
LocalPlayer.CharacterRemoving:Connect(function()
    character = nil
    humanoid = nil
end)

updateReferences()

-- Discord Tab
local TabDiscord = Window:MakeTab({
    Title = "Discord",
    Icon = "rbxassetid://84198990394879"
})

TabDiscord:AddSection("Discord")
TabDiscord:AddDiscordInvite({
    Name = "Zeta Hub",
    Description = "Join the community",
    Logo = "rbxassetid://88800066762467",
    Invite = "https://discord.gg/pzrtAEDBbt"
})

-- Security Tab
local TabSecurity = Window:MakeTab({
    Title = "Security",
    Icon = "rbxassetid://7072718262"
})

TabSecurity:AddSection("Base Tools")

TabSecurity:AddButton({
    Title = "Mark Base Block Location",
    Description = "Save your current position as a base block reference",
    Callback = function()
        if not character then updateReferences() end
        local hrp = character and character:FindFirstChild("HumanoidRootPart")
        if hrp then
            baseBlockLocation = hrp.Position
            print("Base block location marked at:", baseBlockLocation)
        else
            warn("HumanoidRootPart not found")
        end
    end
})

TabSecurity:AddButton({
    Title = "Teleport to Base Block",
    Description = "Teleport instantly to the saved base block location",
    Callback = function()
        if not character then updateReferences() end
        local hrp = character and character:FindFirstChild("HumanoidRootPart")
        if hrp and baseBlockLocation then
            hrp.CFrame = CFrame.new(baseBlockLocation)
            print("Teleported to base block")
        else
            warn("Missing HumanoidRootPart or no location marked")
        end
    end
})

TabSecurity:AddButton({
    Title = "Teleport to Your Side Base",
    Description = "Teleport to the PlotBlock of the current base you're inside",
    Callback = function()
        if not character then updateReferences() end
        if not character then repeat task.wait() until character end

        local hrp = character:FindFirstChild("HumanoidRootPart")
        if not hrp then return end

        local sideModel = nil
        for _, base in pairs(workspace:GetChildren()) do
            if base:IsA("Model") and base.Name:match("^%d+ Side$") then
                if character:IsDescendantOf(base) then
                    sideModel = base
                    break
                end
            end
        end

        if sideModel then
            local plot = sideModel:FindFirstChild("PlotBlock", true)
            if plot then
                hrp.CFrame = plot.CFrame + Vector3.new(0, 5, 0)
                print("Teleported to PlotBlock:", sideModel.Name)
            else
                warn("PlotBlock not found in", sideModel.Name)
            end
        else
            warn("No base detected")
        end
    end
})

-- Main Tab
local TabMain = Window:MakeTab({
    Title = "Main",
    Icon = "rbxassetid://106319096400681"
})

TabMain:AddSection("Movement")

TabMain:AddButton({
    Title = "Mark Location",
    Description = "Saves your current position for teleport",
    Callback = function()
        if not character then updateReferences() end
        local hrp = character and character:FindFirstChild("HumanoidRootPart")
        if hrp then
            markedLocation = hrp.Position
            print("Marked location at:", markedLocation)
        else
            warn("HumanoidRootPart not found")
        end
    end
})

TabMain:AddButton({
    Title = "Tween Teleport to Marked Location",
    Description = "Smooth teleport with wall pass and immunity",
    Callback = function()
        if not character then updateReferences() end
        if not character then return end
        
        local hrp = character:FindFirstChild("HumanoidRootPart")
        local humanoid = character:FindFirstChildOfClass("Humanoid")
        if not hrp or not humanoid or not markedLocation then return end

        local originalHealth = humanoid.Health
        local immune = true
        local healthConn = humanoid:GetPropertyChangedSignal("Health"):Connect(function()
            if immune and humanoid.Health < originalHealth then
                humanoid.Health = originalHealth
            end
        end)

        local affectedParts = {}
        for _, part in ipairs(character:GetDescendants()) do
            if part:IsA("BasePart") and part.Name ~= "HumanoidRootPart" then
                table.insert(affectedParts, { part = part, t = part.Transparency, c = part.CanCollide })
                part.Transparency = 1
                part.CanCollide = false
            elseif part:IsA("Decal") then
                part.Transparency = 1
            end
        end

        local removedWalls = {}
        for _, obj in ipairs(workspace:GetDescendants()) do
            if obj:IsA("BasePart") and obj.Name:lower():find("wall") then
                table.insert(removedWalls, { part = obj, t = obj.Transparency, c = obj.CanCollide })
                obj.Transparency = 1
                obj.CanCollide = false
            end
        end

        local dist = (hrp.Position - markedLocation).Magnitude
        local tweenInfo = TweenInfo.new(dist / 40, Enum.EasingStyle.Linear)
        local tween = TweenService:Create(hrp, tweenInfo, {CFrame = CFrame.new(markedLocation + Vector3.new(0, 3, 0))})
        tween:Play()

        tween.Completed:Connect(function()
            immune = false
            if healthConn then healthConn:Disconnect() end
            for _, data in ipairs(affectedParts) do
                if data.part and data.part.Parent then
                    data.part.Transparency = data.t
                    data.part.CanCollide = data.c
                end
            end
            for _, data in ipairs(removedWalls) do
                if data.part and data.part.Parent then
                    data.part.Transparency = data.t
                    data.part.CanCollide = data.c
                end
            end
        end)
    end
})

-- Anti-Ragdoll Toggle
TabMain:AddSection("Anti-Ragdoll")

local antiRagdollEnabled = false
local antiRagdollConnection

TabMain:AddToggle({
    Title = "Anti-Ragdoll",
    Description = "Prevents your character from turning into ragdoll",
    Default = false,
    Callback = function(state)
        antiRagdollEnabled = state
        if state then
            warn("Anti-Ragdoll enabled")
            if antiRagdollConnection then antiRagdollConnection:Disconnect() end
            
            antiRagdollConnection = RunService.Heartbeat:Connect(function()
                if not character then 
                    updateReferences()
                    if not character then return end
                end
                
                for _, limb in ipairs({"Left Arm", "Right Arm", "Left Leg", "Right Leg", "Head", "Torso", "UpperTorso", "LowerTorso"}) do
                    local part = character:FindFirstChild(limb)
                    if part then
                        for _, c in ipairs(part:GetChildren()) do
                            if c:IsA("BallSocketConstraint") or c:IsA("HingeConstraint") then
                                c:Destroy()
                            end
                        end
                    end
                end
                
                for _, joint in ipairs(character:GetDescendants()) do
                    if joint:IsA("Motor6D") and joint.Parent then
                        joint.Enabled = true
                    end
                end
            end)
        else
            warn("Anti-Ragdoll disabled")
            if antiRagdollConnection then
                antiRagdollConnection:Disconnect()
                antiRagdollConnection = nil
            end
        end
    end
})
